<!-- 

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Channels</title>
    <link rel="stylesheet" href="webstyle.css" />
</head>
<body>
<header>
    <h2 class="Logo">Destroyers</h2>
    <nav class="navigation">
        <a href="channel.html">Back</a>
    </nav>
</header>

<div class="body">
    <h2>All Channels</h2>
    <ul id="channelsList"></ul>
</div>

<script>
    async function fetchUsersChannels() {
        const urlParams = new URLSearchParams(window.location.search);
        const our_id = urlParams.get("our_id");
        console.log("OUR ID IS: ", our_id);
        try {
            const response = await fetch("http://localhost:3000/get-user-channels", {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ current_user_id: our_id })
            });

            const data = await response.json();
            console.log("Channels are: ", data);
            const channelsList = document.getElementById("channelsList");

            data.channels.forEach(channel => {
                const li = document.createElement("li");
                li.textContent = channel.channelname;  // Показываем имя канала

                // Кнопка "Leave"
                const leaveButton = document.createElement("button");
                leaveButton.textContent = "Leave";
                            leaveButton.addEventListener("click", (event) => {
                event.stopPropagation();  // Останавливаем дальнейшее распространение события
                leaveChannel(channel.id, our_id);
            });

                // Добавляем кнопку в элемент списка
                li.appendChild(leaveButton);

                // Добавляем обработчик для перехода на страницу канала
                li.addEventListener("click", () => {
                    window.location.href = `channelPage.html?channelName=${channel.channelname}&our_id=${our_id}&channelId=${channel.id}`;
                });

                channelsList.appendChild(li);
            });
        } catch (error) {
            console.error("Error fetching users:", error);
        }
    }

    // Функция для покидания канала
   async function leaveChannel(channelId, userId) {
    try {
        const response = await fetch("http://localhost:3000/deassign-user", {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ channelId, userId })
        });

        // Проверка статуса ответа
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log("Server response:", result);

        // Проверка сообщения
        if (result.message === 'User removed from channel') {
            alert('You have left the channel');
            // Обновляем список каналов
            document.getElementById("channelsList").innerHTML = '';  // Очистка списка
            fetchUsersChannels();  // Повторный запрос для обновления
        } else {
            alert('Error leaving the channel');
        }
    } catch (error) {
        console.error("Error leaving channel:", error);
        alert('Error leaving the channel');
    }
}

    fetchUsersChannels();
</script>
</body>
</html> -->


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Channels</title>
  <link rel="stylesheet" href="webstyle.css" />
  <style>
    /* Простой CSS для двух колонок */
    .channels-columns {
      display: flex;
      gap: 20px;
    }
    .column {
      flex: 1;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 4px;
    }
    .column h3 {
      text-align: center;
    }
    .column ul {
      list-style: none;
      padding: 0;
    }
    .column li {
      padding: 5px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .column li button {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h2 class="Logo">Destroyers</h2>
    <nav class="navigation">
      <a href="channel.html">Back</a>
    </nav>
  </header>

  <div class="body">
    <h2>All Channels</h2>
    <div class="channels-columns">
      <div class="column">
        <h3>General Channels</h3>
        <ul id="generalChannelsList"></ul>
      </div>
      <div class="column">
        <h3>Private Channels</h3>
        <ul id="privateChannelsList"></ul>
      </div>
    </div>
  </div>

  <script>
    async function fetchUsersChannels() {
      const urlParams = new URLSearchParams(window.location.search);
      const our_id = urlParams.get("our_id");
      console.log("OUR ID IS: ", our_id);
      try {
        const response = await fetch("http://localhost:3000/get-user-channels", {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ current_user_id: our_id })
        });
  
        const data = await response.json();
        console.log("Channels are: ", data);
  
        // Гарантированно получаем массив каналов
        const channels = data.channels || [];
  
        // Фильтруем каналы по типу
        const generalChannels = channels.filter(channel => channel.channeltype === "general");
        const privateChannels = channels.filter(channel => channel.channeltype === "private");
  
        // Получаем контейнеры для отображения
        const generalChannelsList = document.getElementById("generalChannelsList");
        const privateChannelsList = document.getElementById("privateChannelsList");
  
        // Очищаем списки
        generalChannelsList.innerHTML = "";
        privateChannelsList.innerHTML = "";
  
        // Функция для создания элемента списка канала
        function createChannelLi(channel) {
          const li = document.createElement("li");
          li.textContent = channel.channelname;
  
          // Кнопка "Leave"
          const leaveButton = document.createElement("button");
          leaveButton.textContent = "Leave";
          leaveButton.addEventListener("click", (event) => {
            event.stopPropagation(); // Останавливаем всплытие события
            leaveChannel(channel.id, our_id);
          });
  
          li.appendChild(leaveButton);
  
          // Обработчик для перехода на страницу канала
          li.addEventListener("click", () => {
            window.location.href = `channelPage.html?channelName=${encodeURIComponent(channel.channelname)}&our_id=${our_id}&channelId=${channel.id}`;
          });
  
          return li;
        }
  
        // Отрисовываем каналы в соответствующих колонках
        generalChannels.forEach(channel => {
          generalChannelsList.appendChild(createChannelLi(channel));
        });
  
        privateChannels.forEach(channel => {
          privateChannelsList.appendChild(createChannelLi(channel));
        });
  
      } catch (error) {
        console.error("Error fetching channels:", error);
      }
    }
  
    async function leaveChannel(channelId, userId) {
      try {
        const response = await fetch("http://localhost:3000/deassign-user", {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ channelId, userId })
        });
  
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
  
        const result = await response.json();
        console.log("Server response:", result);
  
        if (result.message === 'User removed from channel') {
          alert('You have left the channel');
          // Обновляем список каналов
          document.getElementById("generalChannelsList").innerHTML = '';
          document.getElementById("privateChannelsList").innerHTML = '';
          fetchUsersChannels();
        } else {
          alert('Error leaving the channel');
        }
      } catch (error) {
        console.error("Error leaving channel:", error);
        alert('Error leaving the channel');
      }
    }
  
    fetchUsersChannels();
  </script>
</body>
</html>
